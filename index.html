<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2D5A27">
  <title>マイクラ学習クエスト3D</title>
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Loading Screen -->
<div id="loading-screen">
  <div class="title">マイクラ学習クエスト3D</div>
  <div id="loading-bar-wrap"><div id="loading-bar"></div></div>
  <div id="loading-text">読み込み中...</div>
</div>

<!-- Title Screen -->
<div id="title-screen" class="hidden">
  <div class="title-logo">🌍 マイクラ学習クエスト<br>3Dワールド</div>
  <div class="title-sub">3Dの村を歩きながら学習しよう！</div>
  <button class="btn-title" id="btn-start">▶ スタート</button>
  <button class="btn-title" id="btn-continue" style="background:linear-gradient(180deg,#88ccff,#3366aa);box-shadow:0 4px 0 #1a3a77;color:#fff;">つづきから</button>
  <button class="btn-title" id="btn-char" style="background:linear-gradient(180deg,#cc88ff,#8833cc);box-shadow:0 4px 0 #5511aa;color:#fff;">🧑 キャラクター</button>
  <button class="btn-title" id="btn-settings-title" style="background:linear-gradient(180deg,#aaaaaa,#666666);box-shadow:0 4px 0 #333333;color:#fff;">⚙️ せってい</button>
</div>

<!-- Character Select -->
<div id="char-select" class="hidden">
  <div class="char-select-inner">
    <div class="char-select-title">🧑 キャラクターを えらんでね！</div>
    <div id="char-grid"></div>
    <div class="char-select-btns">
      <button id="btn-char-back" class="char-btn char-btn-back">← もどる</button>
      <button id="btn-char-ok"   class="char-btn char-btn-ok">✓ けってい！</button>
    </div>
  </div>
</div>

<!-- Three.js Canvas -->
<canvas id="game-canvas"></canvas>

<!-- HUD -->
<div id="hud" class="hidden">
  <div class="hud-hearts" id="hud-hearts"></div>
  <div class="hud-level" id="hud-level">Lv.1</div>
  <div class="hud-xp-wrap">
    <div class="hud-xp-label">XP: <span id="hud-xp-text">0 / 50</span></div>
    <div class="hud-xp-bar-bg"><div class="hud-xp-bar" id="hud-xp-bar" style="width:0%"></div></div>
  </div>
  <div class="hud-buildings" id="hud-buildings">建物: 0 / 17</div>
  <div class="hud-achievements" id="hud-achievements">🏅 0 / 16</div>
  <div class="hud-day" id="hud-day">☀️ 1日目</div>
</div>
<button class="hud-home-btn hidden" id="btn-home">🏠 ホーム</button>
<button id="btn-exit-building" class="hidden">🚪 でる</button>
<button class="hud-settings-btn hidden" id="btn-settings">⚙️</button>
<button class="hud-craft-btn hidden" id="btn-craft">⚒️ クラフト</button>

<!-- Craft Menu -->
<div id="craft-menu" class="hidden">
  <div class="craft-inner">
    <div class="craft-title">⚒️ クラフト</div>
    <div id="craft-list"></div>
    <button id="btn-craft-close">✕ とじる</button>
  </div>
</div>

<!-- Interact Hint -->
<div id="interact-hint" class="hidden">近くに場所があります</div>

<!-- Building Action Button (建物内アクション専用・常時DOMに存在) -->
<button id="btn-building-action" class="hidden"></button>

<!-- Building Popup -->
<div id="building-popup" class="hidden">
  <div class="bp-name" id="bp-name"></div>
  <div id="bp-desc"></div>
  <div class="bp-lock" id="bp-lock"></div>
</div>

<!-- Inventory Hotbar -->
<div id="hotbar" class="hidden">
  <div class="hotbar-slot"><span class="hs-icon">🪵</span><span class="hs-count" id="inv-wood">0</span></div>
  <div class="hotbar-slot"><span class="hs-icon">🪨</span><span class="hs-count" id="inv-stone">0</span></div>
  <div class="hotbar-slot"><span class="hs-icon">⚙️</span><span class="hs-count" id="inv-iron">0</span></div>
  <div class="hotbar-slot"><span class="hs-icon">✨</span><span class="hs-count" id="inv-gold">0</span></div>
  <div class="hotbar-slot"><span class="hs-icon">💎</span><span class="hs-count" id="inv-diamond">0</span></div>
</div>

<!-- Mining Popup -->
<div id="mining-popup" class="hidden">
  <div id="mining-modal">
    <div class="mining-header">
      <span class="mining-item-icon" id="mining-item-icon">🪵</span>
      <span class="mining-item-name" id="mining-item-name">木材をGetしよう！</span>
    </div>
    <div class="mining-question" id="mining-question"></div>
    <div class="mining-options" id="mining-options"></div>
    <div class="mining-feedback hidden" id="mining-feedback"></div>
  </div>
</div>

<!-- Building Action Popup -->
<div id="building-action-popup" class="hidden">
  <div id="mining-modal">
    <div class="mining-header">
      <span class="mining-item-icon" id="ba-icon">🛌</span>
      <span class="mining-item-name" id="ba-label">ねる</span>
    </div>
    <div class="mining-question" id="ba-question"></div>
    <div class="mining-options" id="ba-options"></div>
    <div class="mining-feedback hidden" id="ba-feedback"></div>
  </div>
</div>

<!-- Mobile Controls -->
<div id="mobile-controls" class="hidden">
  <div id="dpad-area">
    <div id="dpad">
      <button class="dpad-btn" id="dpad-up">▲</button>
      <div class="dpad-row">
        <button class="dpad-btn" id="dpad-left">◀</button>
        <div class="dpad-center"></div>
        <button class="dpad-btn" id="dpad-right">▶</button>
      </div>
      <button class="dpad-btn" id="dpad-down">▼</button>
    </div>
    <div id="look-pad">
      <button class="dpad-btn look-btn" id="look-up">👁️↑</button>
      <button class="dpad-btn look-btn" id="look-down">👁️↓</button>
    </div>
  </div>
  <button id="btn-interact" class="hidden">👆<br>はいる</button>
</div>

<!-- Settings Panel -->
<div id="settings-panel" class="hidden">
  <div class="settings-inner">
    <div class="settings-title">⚙️ せってい</div>
    <div class="settings-section">
      <div class="settings-label">🏃 いどうスピード</div>
      <div class="settings-speed-btns">
        <button class="speed-btn" data-speed="0.6">🐢 おそい</button>
        <button class="speed-btn" data-speed="1.0">👣 ふつう</button>
        <button class="speed-btn" data-speed="1.6">🐇 はやい</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-label">📚 もんだいの むずかしさ</div>
      <div class="settings-diff-btns">
        <button class="diff-btn" data-diff="easy">🌱 かんたん</button>
        <button class="diff-btn" data-diff="normal">📖 ふつう</button>
        <button class="diff-btn" data-diff="hard">🔥 むずかしい</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-label">🎵 BGM おんりょう <span id="settings-bgm-val">50%</span></div>
      <input type="range" class="settings-slider" id="settings-bgm" min="0" max="100" step="5" value="50">
    </div>
    <div class="settings-section">
      <div class="settings-label">🔔 こうかおん おんりょう <span id="settings-se-val">70%</span></div>
      <input type="range" class="settings-slider" id="settings-se" min="0" max="100" step="5" value="70">
    </div>
    <div class="settings-section">
      <div class="settings-label">📊 がくしゅうきろく</div>
      <button class="settings-export-btn" id="btn-export-stats">📥 エクスポート</button>
      <button class="settings-export-btn" id="btn-review-stats" style="margin-top:6px">📋 もんだいをみる</button>
    </div>
    <div class="settings-section">
      <div class="settings-label">☁️ クラウド同期 <span style="font-size:.7rem;color:#aaa">（管理者が設定）</span></div>
      <input type="password" class="settings-token-input" id="settings-token" placeholder="ghp_... （gistスコープのトークン）" autocomplete="off">
      <div style="margin-top:6px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="settings-export-btn" id="btn-sync-now">🔄 今すぐ同期</button>
        <span id="sync-status" style="font-size:.75rem;color:#aaa"></span>
      </div>
    </div>
    <button class="settings-close-btn" id="btn-settings-close">✓ とじる</button>
  </div>
</div>

<!-- Damage Flash -->
<div id="damage-flash"></div>

<!-- Death Screen -->
<div id="death-screen" class="hidden">
  <div class="death-inner">
    <div class="death-msg">💀 やられた！</div>
    <div id="death-item-loss" style="font-size:0.9rem;color:#faa;margin:8px 0;min-height:1.2em;"></div>
    <button id="btn-respawn">♻️ もう一度！</button>
  </div>
</div>

<!-- CSV Update Popup -->
<div id="update-popup" class="hidden">
  <div class="update-inner">
    <div class="update-icon">📚✨</div>
    <div class="update-msg">あたらしい もんだいが<br>とどいたよ！</div>
    <div class="update-sub">ボタンを おしてね！</div>
    <button id="btn-update-ok">🔄 くるくる！</button>
  </div>
</div>

<!-- Question Review Panel -->
<div id="review-panel" class="hidden">
  <div class="review-inner">
    <div class="review-header">
      <span class="review-title">📋 もんだいリスト</span>
      <button id="btn-review-close">✕ とじる</button>
    </div>
    <div class="review-filters">
      <button class="rv-filter active" data-subj="all">全部</button>
      <button class="rv-filter" data-subj="math">さんすう</button>
      <button class="rv-filter" data-subj="japanese">こくご</button>
      <button class="rv-filter" data-subj="english">えいご</button>
    </div>
    <div class="review-counter" id="review-counter"></div>
    <div class="review-card" id="review-card"></div>
    <div class="review-nav">
      <button id="btn-rv-prev">◀ まえ</button>
      <button id="btn-rv-next">つぎ ▶</button>
    </div>
  </div>
</div>

<!-- Daily Bonus Popup -->
<div id="daily-bonus" class="hidden">
  <div class="daily-inner">
    <div class="daily-title">🌅 おはよう！</div>
    <div class="daily-streak" id="daily-streak">🌱 きょうも がくしゅうしよう！</div>
    <div class="daily-items" id="daily-items"></div>
    <button id="btn-daily-ok">✨ うけとる！</button>
  </div>
</div>

<!-- Level Up Banner -->
<div id="levelup-banner" class="hidden">
  <div class="levelup-title">⭐ レベルアップ！</div>
  <div class="levelup-lv" id="levelup-lv">Lv.2</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="quiz-data.js"></script>
<script src="app.js"></script>
</body>
</html>
